# VowKy UI 层代码审阅报告

---

## 1. RecordingPanel.swift

### 界面职责
录音状态浮窗——在用户触发语音输入时，以悬浮面板的形式实时反馈当前录音/识别/错误状态。

### 页面构成
- **浮窗容器**：基于 NSPanel 的非激活型无边框悬浮面板，内嵌 SwiftUI 视图。
- **录音态视图**：左侧脉冲麦克风图标 + 右侧"正在聆听..."文字 + 音量电平条。
- **识别态视图**：系统加载转圈指示器 + "识别中..."文字。
- **提示态视图（Toast）**：警告三角图标 + "未识别到语音，请重试"提示文字。

### 交互流程
1. 应用状态变为 recording 或 recognizing 时，浮窗自动显示在屏幕顶部居中位置。
2. 录音期间，音量电平条实时随音频输入强度变化。
3. 识别成功（lastResult 产生新值）时，浮窗立即隐藏。
4. 从 recognizing 回到 idle 且无新结果时，显示"未识别到语音"的 toast 提示，3 秒后自动隐藏。
5. 状态变为 loading 或 outputting 时，浮窗隐藏。

### 视觉规格
- **面板尺寸**：260×80 pt，圆角 16 pt。
- **背景效果**：NSVisualEffectView，材质为 hudWindow（深色半透明毛玻璃），混合模式为 behindWindow。
- **面板层级**：floating 级别，跨所有桌面和全屏空间显示，带系统阴影。
- **定位**：主屏幕可见区域顶部水平居中，距顶部约 120 pt。
- **麦克风图标**：SF Symbols mic.fill，24 pt，红色，0.6 秒周期缩放脉冲动画（1.0↔1.15）。
- **音量电平条**：高度 4 pt，胶囊形，背景灰色 30% 透明度，前景绿色，宽度按 0-1 归一化音量值线性填充，0.05 秒线性动画过渡。
- **文字**：标题 14 pt medium 字重；toast 文字 12 pt，辅助色。
- **警告图标**：橙色三角感叹号。

### 状态变化
| 应用状态 | 浮窗行为 |
|---------|---------|
| recording | 显示：脉冲麦克风 + 聆听文字 + 音量条 |
| recognizing | 显示：加载圈 + 识别中文字 |
| idle（从 recognizing 转来且无结果）| 显示：toast 警告提示，3 秒后自动消失 |
| idle（其他来源）| 立即隐藏 |
| loading / outputting | 立即隐藏 |
| lastResult 更新 | 立即隐藏（识别成功） |

### 与其他模块的依赖关系
- 依赖 **AppState**（@EnvironmentObject）：读取 state 枚举值控制视图切换，读取 audioLevel 驱动音量条。
- 依赖 **AudioRecorderProtocol**：通过 AppState 扩展属性 audioLevel 间接读取录音器的实时音量。
- 不依赖其他 View 文件，是完全独立的浮窗组件。

---

## 2. MenuBarView.swift

### 界面职责
菜单栏下拉菜单——作为应用常驻入口，展示当前状态、最近识别结果和快捷操作。

### 页面构成
- **状态行**：彩色小圆点 + 状态文字（如"Ready (Option+Space)"）。
- **识别历史区**（条件显示）：标题"识别历史" + 最近结果列表（每条含文字和复制按钮）+ "查看全部历史"按钮。
- **错误消息区**（条件显示）：红色错误提示文字。
- **设置按钮**：齿轮图标 + "Settings"文字。
- **退出按钮**：电源图标 + "Quit VowKy"文字。

### 交互流程
1. 用户点击菜单栏图标，下拉菜单展开，显示当前运行状态。
2. 有历史识别结果时，列表显示最近的识别文本（每条最多 2 行），点击右侧复制按钮将该条文本写入系统剪贴板。
3. 点击"查看全部历史"按钮，调用 HistoryWindowController 单例打开完整的历史记录窗口。
4. 若存在错误信息，在分隔线下方以红色字体展示。
5. 点击 Settings 按钮，调用 SettingsWindowController 单例打开设置窗口。
6. 点击 Quit VowKy 按钮，终止应用。

### 视觉规格
- **菜单宽度**：220 pt。
- **状态圆点**：8×8 pt 实心圆，颜色随状态变化——loading 橙色、idle 绿色、recording 红色、recognizing 黄色、outputting 蓝色。
- **状态文字**：caption 字号，辅助色。
- **历史条目文字**：12 pt，限 2 行。
- **复制按钮**：doc.on.doc 图标，10 pt，朴素按钮样式，hover 提示"复制到剪贴板"。
- **错误文字**：11 pt，红色。
- **各区域之间以 Divider 分隔**。
- **内边距**：水平 12 pt，垂直按区域 2-8 pt 不等。

### 状态变化
| 应用状态 | 状态行显示 |
|---------|----------|
| loading | 橙色圆点 + "Loading model..." |
| idle | 绿色圆点 + "Ready (Option+Space)" |
| recording | 红色圆点 + "Recording..." |
| recognizing | 黄色圆点 + "Recognizing..." |
| outputting | 蓝色圆点 + "Outputting..." |

- recentResults 为空时，历史区整体不显示。
- errorMessage 为 nil 时，错误区不显示。

### 与其他模块的依赖关系
- 依赖 **AppState**（@ObservedObject）：读取 state、recentResults、errorMessage。
- 依赖 **HistoryWindowController**：点击"查看全部历史"时调用其单例打开窗口。
- 依赖 **SettingsWindowController**：点击 Settings 时调用其单例打开窗口。
- 依赖 **NSPasteboard**：复制功能直接操作系统剪贴板。
- 依赖 **NSApplication**：退出功能调用 terminate。

---

## 3. SettingsView.swift

### 界面职责
设置窗口——提供快捷键自定义、模型信息查看、权限状态检查和开机自启动配置。

### 页面构成
- **窗口控制器**：SettingsWindowController 单例管理 NSWindow 生命周期，窗口标题"VowKy Settings"，可关闭但不可缩放。
- **快捷键区（Section "快捷键"）**：标签"语音输入" + 当前快捷键显示 + "修改/取消"按钮。
- **语音模型区（Section "语音模型"）**：显示模型名"Paraformer-zh (int8)"和引擎名"sherpa-onnx (本地)"。
- **权限区（Section "权限"）**：辅助功能授权状态 + 麦克风权限说明。
- **通用区（Section "通用"）**：开机自启 Toggle 开关。

### 交互流程
1. 窗口打开时自动刷新辅助功能授权状态、开机自启状态和当前快捷键显示。
2. **快捷键修改流程**：
   - 点击"修改"按钮，进入按键录制模式，文字变为"请按下新快捷键..."（橙色等宽字体）。
   - 用户按下任意带修饰符的组合键，系统捕获键码和修饰符，保存到 HotkeyConfig，更新显示。
   - 纯修饰键（Command/Shift/Option/Control）被忽略，不触发录制完成。
   - 按 Escape（无修饰符）取消录制。
   - 点击"取消"按钮也可退出录制模式。
3. **辅助功能授权**：未授权时显示红色"未授权"和"前往设置"按钮，点击后弹出系统辅助功能权限对话框。
4. **开机自启**：Toggle 切换时通过 SMAppService 注册/注销，失败时自动回滚开关状态。
5. 窗口关闭时自动停止快捷键录制（移除事件监听器）。

### 视觉规格
- **窗口尺寸**：380×380 pt，居中显示，仅可关闭（标题栏 + 关闭按钮）。
- **表单样式**：SwiftUI grouped 分组表单。
- **快捷键文字**：系统等宽字体（monospaced），录制中为橙色。
- **修改/取消按钮**：bordered 样式，small 尺寸。
- **授权状态文字**：已授权绿色，未授权红色。
- **麦克风状态**：固定显示"由系统管理"，辅助色。
- **模型和引擎信息**：LabeledContent 标签-值对形式呈现。

### 状态变化
| 状态 | UI 表现 |
|------|--------|
| 非录制模式 | 显示当前快捷键名称 + "修改"按钮 |
| 录制模式 | 显示"请按下新快捷键..."橙色文字 + "取消"按钮 |
| 辅助功能已授权 | 绿色"已授权"文字 |
| 辅助功能未授权 | 红色"未授权"文字 + "前往设置"按钮 |
| 开机自启开/关 | Toggle 开关对应状态 |

### 与其他模块的依赖关系
- 依赖 **HotkeyConfig**：读取和保存快捷键配置，获取 displayName 用于显示。
- 依赖 **AXIsProcessTrusted / AXIsProcessTrustedWithOptions**：检查和请求辅助功能权限。
- 依赖 **SMAppService**：管理开机自启注册/注销。
- 依赖 **NSEvent**：监听键盘事件实现快捷键录制。
- SettingsWindowController 被 MenuBarView 调用。

---

## 4. HistoryView.swift

### 界面职责
历史记录窗口——展示所有语音识别结果的完整列表，支持搜索、复制和删除操作。

### 页面构成
- **窗口控制器**：HistoryWindowController 单例管理 NSWindow，窗口标题"VowKy 识别历史"，可关闭、缩放、最小化。
- **搜索栏**：放大镜图标 + 搜索输入框 + 清除按钮（有搜索文字时出现）。
- **记录列表**：每条记录包含识别文本（最多 3 行）、时间戳，悬停时显示复制和删除按钮。
- **空状态占位**：时钟图标 + 提示文字（"还没有输入记录"或"未找到相关记录"）。
- **底部状态栏**：左侧显示总记录数 + 右侧"清空全部"按钮（有记录时才显示）。

### 交互流程
1. 窗口打开时自动加载全部历史记录。
2. 在搜索框输入文字时，实时过滤匹配记录（每次文字变化触发重新加载）。
3. 点击搜索框右侧清除按钮（X），清空搜索文字，恢复全部记录。
4. 鼠标悬停在某条记录上时，右侧浮现复制和删除两个操作按钮。
5. 点击复制按钮，将该条记录文字写入系统剪贴板。
6. 点击删除按钮，从存储中删除该条记录并刷新列表。
7. 点击底部"清空全部"按钮，删除所有历史记录并刷新。

### 视觉规格
- **窗口尺寸**：默认 500×600 pt，最小 400×400 pt，可自由缩放和最小化。
- **搜索栏**：内边距 10 pt，背景色为系统控件背景色（controlBackgroundColor）。
- **搜索图标**：辅助色放大镜。
- **清除按钮**：xmark.circle.fill 图标，辅助色。
- **空状态图标**：时钟图标，40 pt，辅助色。
- **记录文字**：13 pt，限 3 行。
- **时间戳**：caption 字号，辅助色；格式——今天显示"今天 HH:mm"，昨天显示"昨天 HH:mm"，更早显示"MM-dd HH:mm"。
- **悬停操作按钮**：12 pt 图标，朴素按钮样式；复制按钮 doc.on.doc，删除按钮 trash（红色）。
- **列表样式**：plain 列表。
- **底部状态栏**：caption 字号，水平内边距 12 pt，垂直 6 pt。
- **"清空全部"按钮**：caption 字号，红色，朴素按钮样式。

### 状态变化
| 场景 | UI 表现 |
|------|--------|
| 有记录 + 无搜索 | 显示全部记录列表 + 底部记录总数 + "清空全部"按钮 |
| 有记录 + 有搜索 | 显示匹配记录 + 底部匹配数 + "清空全部"按钮 |
| 无记录 + 无搜索 | 空状态占位"还没有输入记录" |
| 无记录 + 有搜索 | 空状态占位"未找到相关记录" |
| 鼠标悬停某条记录 | 右侧浮现复制/删除操作按钮 |
| 鼠标离开记录 | 操作按钮消失 |

### 与其他模块的依赖关系
- 依赖 **HistoryStore**（单例）：调用 fetchAll、count、delete、deleteAll 进行数据增删查。
- 依赖 **HistoryRecord** 模型：列表数据源。
- 依赖 **NSPasteboard**：复制功能操作系统剪贴板。
- HistoryWindowController 被 MenuBarView 调用。
